{% extends 'template.html' %}
{% load static %}
{% block extra_css %}
    <style>
        h3, h4, h5.mb {
            color: #333;
        }
        th,td{
            text-align: center;
        }

    </style>
{% endblock %}

{% block main_content %}

    <section id="main-content">
        <section class="wrapper">
            <h3><i class="fa fa-angle-right"></i>搜索文档流
            </h3>
            <div class="row mt">
                <div class="col-lg-12">
                    <div class="form-panel3">
                        <form id='material1' class="form-horizontal style-form" formmethod="post">
                            <div style="margin-left: 15px">
                                <div class="row">
                                    <div class="col-sm-3">
                                        <input class="form-control" id="itemid1" name='pk' type="text"
                                               placeholder="请输入商品项编号" >
                                    </div>
                                    <div class="col-sm-3">

                                        <select id="time0" class="form-control">
                                            <option value='0'>全部</option>
                                            <option value='2'>近三月</option>
                                            <option value='1'>近半年</option>
                                        </select>

                                    </div>

                                    <button type="submit" formmethod="post" class="btn btn-success "><i
                                            class="fa fa-search"></i></button>
                                </div>
                                <br>
                                <div class="row">
                                    <div class="col-sm-3">
                                        <button type="button" class="btn btn-link " data-toggle="modal"
                                                data-target="#myModal1">
                                            忘记编号？
                                        </button>
                                    </div>


                                </div>
                            </div>
                        </form>
                        <div id='details'>
                            <div class="row mt">
                                <div class="col-md-12">
                                    <div class="col-md-12">
                                        <div class="content-panel">
                                            <table class="table table-striped table-advance table-hover" id="table1">

                                                <thead>
                                                <tr>
                                                    <th>采购订单编号</th>
                                                    <th>条目</th>
                                                    <th>商品名称</th>
                                                    <th>供应商</th>
                                                    <th>创建者</th>
                                                    <th>日期</th>
                                                    <th>操作</th>
                                                </tr>
                                                </thead>

                                                <tbody>

                                                </tbody>

                                            </table>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <div class="modal fade" id="myModal1" tabindex="-1" role="dialog"
             aria-labelledby="myModalLabel1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                            &times;
                        </button>
                        <h4 class="modal-title" id="myModalLabel">搜索商品编号</h4>
                    </div>
                    <div class="modal-body">
                        <!-- Hi there, I am a Modal Example for Dashgum Admin Panel. -->
                        <!-- 搜索条件 -->
                        <form id="material2" class="form-horizontal style-form">
                            <div class="form-group">
                                <label class="col-sm-4 col-sm-4 control-label">
                                    <div class="pull-right">商品名称：</div>
                                </label>
                                <div class="col-sm-5">
                                    <input class="form-control" type="text" name="mname" id="mname">
                                </div>
                            </div>


                            <div class="form-group">
                                <label class="col-sm-4 col-sm-4 control-label">
                                    <div class="pull-right">商品类型：</div>
                                </label>
                                <div class="col-sm-5">
                                    <select name="mType" id="mType" class="form-control">
                                        <!-- 默认为未选 -->
                                        <option value=''>请选择商品类型</option>
                                        <option value='RM'>RM--原材料</option>
                                        <option value='HALB'>HALB--半成品</option>
                                        <option value='FERT'>SF00--成品</option>
                                        <option value='FREMD'>FG00--外部采购物料</option>
                                        <option value='PROC'>MI00--加工物料</option>
                                        <option value='HAWA'>RE00--贸易货物</option>
                                        <option value='HIBE'>RE00--经营供应</option>
                                    </select>

                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-4 col-sm-4 control-label">
                                    <div class="pull-right">工业部门：</div>
                                </label>
                                <div class="col-sm-5">
                                    <select class="form-control" name='industrySector'
                                            id='industrySector'>
                                        <option value=''>请选择工业部门</option>
                                        <option value='C'>化学工业</option>
                                        <option value='M'>机械工业</option>
                                        <option value='W'>药剂工业</option>
                                        <option value='F'>设备工程</option>
                                        <option value='R'>零售</option>
                                    </select>

                                </div>
                            </div>


                            <div class="form-group">
                                <label class="col-sm-4 col-sm-4 control-label">
                                    <div class="pull-right">工厂：</div>
                                </label>
                                <div class="col-sm-5">
                                    <select class="form-control" name='plant' id='plant'></select>

                                </div>
                            </div>


                            <div class="form-group">
                                <label class="col-sm-4 col-sm-4 control-label">
                                    <div class="pull-right">存储位置：</div>
                                </label>
                                <div class="col-sm-5">
                                    <select class="form-control" name="sloc" id="sloc">
                                        <option value=''>请选择存储位置</option>
                                        <option value='TG00'>TG00--贸易商品</option>
                                        <option value='RM00'>RM00--原材料</option>
                                        <option value='SF00'>SF00--半成品</option>
                                        <option value='FG00'>FG00--产成品</option>
                                        <option value='MI00'>MI00--混合产品</option>
                                        <option value='RE00'>RE00--退货产品</option>
                                    </select>

                                </div>
                            </div>
                            <div class="form-group">
                                <!-- <label class="col-sm-1 col-sm-1 control-label"></label> -->
                                <label class="col-sm-4 col-sm-4 control-label">
                                    <div class="pull-right">创建者编号：</div>
                                </label>
                                <div class="col-sm-5">
                                    <input name="uid2" id="uid2" type="text" class="form-control">
                                </div>
                                <div class="col-sm-2">
                                    <input type="submit" class="btn btn-theme02">
                                </div>
                            </div>


                        </form>

                        <table class="table table-bordered table-striped table-condensed" id="table2">
                            *双击填入编号
                            <thead>
                            <!-- 搜索编号返回的属性 style="width: 100px;"-->
                            <tr>
                                <th> 商品编号</th>
                                <th> 商品名称</th>
                                <th> 商品类型</th>
                                <th> 工业部门</th>
                                <th> 工厂</th>
                                <th> 存储位置</th>
                                <th> 创建者编号</th>
                                <th> 商品项编号</th>
                            </tr>
                            </thead>
                            <tbody id="searchDiv"></tbody>
                        </table>
                    </div>

                    <div class="modal-footer">

                    </div>
                </div>
            </div>
        </div>
    </section>

{% endblock %}



{% block js %}

    <script>
        $(document).ready(function () {

            //选择工厂下拉框内容
            $.ajax({
                type: "post",
                url: "{% url 'MM:ajax_load_plant' %}",
                data: {
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                },
                success: function (data) {
                    var dataObj = eval("(" + data + ")");
                    var out = "<option value='' >请选择工厂</option>";
                    var i;
                    for (i = 0; i < dataObj.length; i++) {
                        out += '<option value=' + dataObj[i].Plant + '>' + dataObj[i].Plant + '--' + dataObj[i].Name + '</option>';
                    }
                    //由于一个页面里有多个表单，所以用name寻找各个下拉框进行赋值
                    var items = document.getElementsByName("plant");
                    console.log(items);
                    for (i = 0; i < items.length; i++) {
                        items[i].innerHTML = out;
                    }
                },
                failure: function () {

                }
            });



            //编号搜索 如果搜不到，返回提示：没有符合条件的商品（这个就不返回了，可以判断是否为空）
            $('#material2').on('submit', function (e) {
                e.preventDefault();
                $.ajax(
                    {
                        type: "post",
                        url: "{% url 'MM:ajax_search_item' %}",
                        data: {
                            dataType: "json",
                            csrfmiddlewaretoken: '{{ csrf_token }}',
                            mid: '',
                            mname: $("#mname").val(),
                            mType: $("#mType").val(),
                            industrySector: $("#industrySector").val(),
                            sloc: $("#sloc").val(),
                            plant: $("#plant").val(),
                            uid: $('#uid2').val(),
                        },
                        success: function (data) {

                            $('#item_result').text(data);

                            var dataObj = eval("(" + data + ")");
                            if (dataObj == '') {
                                var out = "";
                                document.getElementById("searchDiv").innerHTML = out;
                                showMessage({text: '没有符合条件的商品', type: 'error'});
                            } else {
                                var out = "";
                                var i;
                                for (i = 0; i < dataObj.length; i++) {
                                    //dataObj[i].fields.xx
                                    fields = dataObj[i].fields
                                    itemid = dataObj[i].itemid
                                    material = dataObj[i].material
                                    stock = dataObj[i].stock
                                    user = dataObj[i].user
                                    out += '<tr><td>' + material.id + '</td><td>' + material.mname + '</td><td>' + material.mType + '</td><td>' + material.industrySector + '</td><td>' + stock.name + '</td><td>' + fields.sloc + '</td><td>' + user.id + '</td><td>' + itemid + '</td><tr>';
                                }
                                document.getElementById("searchDiv").innerHTML = out;
                            }

                        },
                        failure: function () {

                        }
                    })
            });

            //双击行 信息进入“搜索商品条件”三个框
            $("#table2").on("dblclick", "tr", function (e) {
                document.getElementById("itemid1").value = $(this).find('td').eq(7).text();
                $('#myModal1').modal('hide');
            });


        });
    </script>

    <script>
        //文档流搜索
        $('#material1').on('submit', function (e) {
            e.preventDefault();
            $.ajax({
                type: "POST",
                url: "{% url 'MM:search_document_flow' %}",
                data: {
                    dataType: "json",
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                    materialitemid: $("#itemid1").val(),//获取商品项id
                    time_range: $("#time0").val()  // 获取时间范围
                },
                success: function (data) {
                    var out = '';
                    data.orderitems.forEach(function (order) {
                        var pkid=order.id;
                        out += '<tr><td>'+ order.po+'</td><td>' + order.itemId +'</td><td>' + order.meterialItem__material__mname + '</td><td>' + order.po__vendor__vname+'</td><td>' + order.po__euser__id  + '</td><td>' + order.po__time + '</td><td><a id="'+pkid+'"'+' onclick="'+'submitpk(this.id)"'+'>查看详情</a></td></tr>';
                    });


                    // 更新页面上的表格
                    $('#table1 tbody').html(out);
                },
                failure: function () {
                    showMessage({text: '搜索失败，请重试。', type: 'error'});
                }
            });
        });
        function submitpk(clicked_id) {
            var pk1=clicked_id;
            var target = "/mm/document/display/" + pk1;
            window.location.href = target;

        }

    </script>


{% endblock %}