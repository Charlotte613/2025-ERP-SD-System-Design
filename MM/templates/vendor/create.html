{% extends 'template.html' %}
{% load static %}
{% block extra_css %}

{% endblock %}

{% block main_content %}

        <!-- MAIN CONTENT -->
        <section id="main-content">
            <section class="wrapper">
                <h3><i class="fa fa-angle-right"></i> 创建新供应商</h3>
                <div class="row mt">
                    <div class="col-lg-12">
                        <div class="form-panel">
                            <h4 class="mb"><i class="fa fa-angle-right"></i> 供应商信息</h4>
                            <form id="material3" class="form-horizontal style-form" method="post">
                                {% csrf_token %}

                                <fieldset>
                                    <div class="form-group">
                                        <label class="col-sm-2 col-sm-2 control-label">
                                            <div class="pull-right">供应商名称： </div>
                                        </label>
                                        <div class="col-sm-7">
                                            <input class="form-control" type="text" name="vname" id="vname2" required>
                                        </div>
                                    </div>
                                    <h5 class='mb'><i class="fa fa-angle-right"></i>联系方式</h5>
                                    <div class="form-group">
                                        <label class="col-sm-2 col-sm-2 control-label">
                                            <div class="pull-right">语言：</div>
                                        </label>
                                        <div class="col-sm-7">
                                            <select class="form-control" name="language" id='language2' required></select>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="col-sm-2 col-sm-2 control-label">
                                            <div class="pull-right">电话： </div>
                                        </label>
                                        <div class="col-sm-7">
                                            <input class="form-control" type="text" name="phone" id='phone2'>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="col-sm-2 col-sm-2 control-label">
                                            <div class="pull-right">传真：</div>
                                        </label>
                                        <div class="col-sm-7">
                                            <input class="form-control" type="text" name="fax" id='fax2'>
                                        </div>
                                    </div>
                                    <h5 class='mb'><i class="fa fa-angle-right"></i>所在地</h5>
                                    <div class="form-group">
                                        <label class="col-sm-2 col-sm-2 control-label">
                                            <div class="pull-right">国家：</div>
                                        </label>
                                        <div class="col-sm-7">
                                            <select class="form-control" name="country" id="country2" required></select>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="col-sm-2 col-sm-2 control-label">
                                            <div class="pull-right">所在城市：</div>
                                        </label>
                                        <div class="col-sm-7">
                                            <input class="form-control" type="text" name="city" id="city2" required>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="col-sm-2 col-sm-2 control-label">
                                            <div class="pull-right">街区地址：</div>
                                        </label>
                                        <div class="col-sm-7">
                                            <input class="form-control" name="address" id="address2" type="text">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="col-sm-2 col-sm-2 control-label">
                                            <div class="pull-right">邮政编码：</div>
                                        </label>
                                        <div class="col-sm-7">
                                            <input class="form-control" name="postcode" id="postcode2" type="text" required>
                                        </div>
                                    </div>
                                    <h5 class='mb'><i class="fa fa-angle-right"></i>交易</h5>
                                    <div class="form-group">
                                        <label class="col-sm-2 col-sm-2 control-label">
                                            <div class="pull-right">公司编码：</div>
                                        </label>
                                        <div class="col-sm-7">
                                            <select class="form-control" name="companyCode" id="company2" required></select>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="col-sm-2 col-sm-2 control-label">
                                            <div class="pull-right">采购组织：</div>
                                        </label>
                                        <div class="col-sm-7">
                                            <select class="form-control" name="pOrg" id="pOrg2" required></select>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="col-sm-2 col-sm-2 control-label">
                                            <div class="pull-right">支付类型：</div>
                                        </label>
                                        <div class="col-sm-7">
                                            <select class="form-control" name="tpType" id="tpType2"></select>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="col-sm-2 col-sm-2 control-label">
                                            <div class="pull-right">交易货币：</div>
                                        </label>
                                        <div class="col-sm-7">
                                            <input type="text" class="form-control po-text-modify" onclick="currencyf()" name="currency" id="currency2">
                                            <div class="col-sm-12">
                                                <div class="modal fade" id="myModalcurr" tabindex="-1" role="dialog" aria-labelledby="myModalLabel1" aria-hidden="true">
                                                    <div class="modal-dialog">
                                                        <div class="modal-content">
                                                            <div class="modal-header">
                                                                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                                                                <h4 class="modal-title" id="myModalLabel">货币</h4>
                                                            </div>
                                                            <div class="modal-body">
                                                                *双击填入货币
                                                                <table class="table table-bordered table-striped table-condensed">
                                                                    <thead>
                                                                        <tr>
                                                                            <th style="width: 100px;">序号</th>
                                                                            <th style="width: 120px;">货币</th>
                                                                            <th>名称</th>
                                                                        </tr>
                                                                    </thead>
                                                                    <tbody id="currDiv"></tbody>
                                                                </table>
                                                            </div>
                                                            <div class="modal-footer"></div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="col-sm-2 col-sm-2 control-label">
                                            <div class="pull-right">总账账户编码：</div>
                                        </label>
                                        <div class="col-sm-7">
                                            <input class="form-control" name="glAcount" id="glAcount2" type="text" required>
                                        </div>
                                    </div>
                                </fieldset>
                                <div class="col-sm-10"></div>
                                <button class="btn btn-theme04" type="reset">重置</button>
                                <input type='submit' class="btn btn-theme" formmethod="post">
                            </form>

                        </div>
                    </div>
                </div>
            </section>
        </section>
    </section>

{% endblock %}



{% block js %}

    <script>
        $(document).ready(function() {
            console.log("Document is ready.");

            $.ajax({
                type: "get",
                url: "{% url 'MM:ajax_load_language' %}",
                data: {
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                },
                success: function(data) {
                    var dataObj = JSON.parse(data);
                    var out = "<option value='' >请选择语言</option>";
                    for (var i = 0; i < dataObj.length; i++) {
                        out += '<option value=' + dataObj[i].Language + '>' + dataObj[i].Language + '--' + dataObj[i].Name + '</option>';
                    }
                    var items = document.getElementsByName("language");
                    for (i = 0; i < items.length; i++) {
                        items[i].innerHTML = out;
                    }
                },
                error: function(xhr, status, error) {
                    console.error("AJAX error: ", status, error);
                    console.log("Response Text: ", xhr.responseText);
                }
            });

            $.ajax({
                type: "post",
                url: "{% url 'MM:ajax_load_tptype' %}",
                data: {
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                },
                success: function(data) {
                    var dataObj = JSON.parse(data);
                    var out = "<option value='' >请选择支付类型</option>";
                    for (var i = 0; i < dataObj.length; i++) {
                        out += '<option value=' + dataObj[i].Tptype + '>' + dataObj[i].Tptype + '--' + dataObj[i].Description + '</option>';
                    }
                    var items = document.getElementsByName("tpType");
                    for (i = 0; i < items.length; i++) {
                        items[i].innerHTML = out;
                    }
                },
                error: function(xhr, status, error) {
                    console.error("AJAX error: ", status, error);
                    console.log("Response Text: ", xhr.responseText);
                }
            });

            $.ajax({
                type: "post",
                url: "{% url 'MM:ajax_load_country' %}",
                data: {
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                },
                success: function(data) {
                    var dataObj = eval("("+data+")");
                    var out = "<option value='' >请选择国家</option>";
                    var i;
                    for(i = 0; i < dataObj.length; i++) {
                        out += '<option value=' + dataObj[i].Country+'>'+ dataObj[i].ChineseName + '--' + dataObj[i].EnglishName + '</option>' ;
                    }
                    var items=document.getElementsByName("country");
                    for(i = 0; i < items.length; i++) {
                        items[i].innerHTML=out;
                    }

                    },
                failure: function() {

                }
            });

            $.ajax({
                type: "post",
                url: "{% url 'MM:ajax_load_company' %}",
                data: {
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                },
                success: function(data) {
                    var dataObj = JSON.parse(data);
                    var out = "<option value='' >请选择公司编码</option>";
                    for (var i = 0; i < dataObj.length; i++) {
                        out += '<option value=' + dataObj[i].CompanyCode + '>' + dataObj[i].CompanyCode + '--' + dataObj[i].Name + '</option>';
                    }
                    var items = document.getElementsByName("companyCode");
                    for (i = 0; i < items.length; i++) {
                        items[i].innerHTML = out;
                    }
                },
                error: function(xhr, status, error) {
                    console.error("AJAX error: ", status, error);
                    console.log("Response Text: ", xhr.responseText);
                }
            });

            $.ajax({
                type: "post",
                url: "{% url 'MM:ajax_load_porg' %}",
                data: {
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                },
                success: function(data) {
                    var dataObj = JSON.parse(data);
                    var out = "<option value='' >请选择采购组织</option>";
                    for (var i = 0; i < dataObj.length; i++) {
                        out += '<option value=' + dataObj[i].Porg + '>' + dataObj[i].Porg + '--' + dataObj[i].Name + '</option>';
                    }
                    var items = document.getElementsByName("pOrg");
                    for (i = 0; i < items.length; i++) {
                        items[i].innerHTML = out;
                    }
                },
                error: function(xhr, status, error) {
                    console.error("AJAX error: ", status, error);
                    console.log("Response Text: ", xhr.responseText);
                }
            });

            // AJAX 请求获取货币数据
            $.ajax({
                type: "post",
                url: "{% url 'MM:ajax_load_currency' %}",
                data: {
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                },
                success: function(data) {
                    console.log("Data received: ", data);
                    var dataObj = JSON.parse(data);
                    var out = "";
                    for (var i = 0; i < dataObj.length; i++) {
                        out += '<tr><td>' + (i + 1) + '</td><td>' + dataObj[i].Currency + '</td><td>' + dataObj[i].Name + '</td></tr>';
                    }
                    document.getElementById("currDiv").innerHTML = out;
                },
                error: function(xhr, status, error) {
                    console.error("AJAX error: ", status, error);
                    console.log("Response Text: ", xhr.responseText);
                }
            });

            // 双击表格行填入货币
            $("#currDiv").on("dblclick", "tr", function(e) {
                var currency = $(this).find('td').eq(1).text();
                document.getElementById("currency2").value = currency;
                $('#myModalcurr').modal('hide');
            });
        });

            // 显示货币选择模态框
            function currencyf() {
                console.log("Currency input clicked.");
                $("#myModalcurr").modal("show");
            }

        // 提交表单
    $('#material3').on('submit', function(e) {
        e.preventDefault();

        let phone = $("#phone2").val();
        let fax = $("#fax2").val();
        let phoneError = validatePhoneNumber(phone);
        let faxError = validateDigits(fax);

        if (phoneError) {
            alert(phoneError);
            return;
        }
        if (faxError) {
            alert(faxError);
            return;
        }

        $.ajax({
            type: "POST",
            url: "{% url 'MM:create_vendor' %}",
            data: {
                csrfmiddlewaretoken: '{{ csrf_token }}',
                vname: $("#vname2").val(),
                city: $("#city2").val(),
                address: $("#address2").val(),
                postcode: $("#postcode2").val(),
                country: $("#country2").val(),
                language: $("#language2").val(),
                glAcount: $("#glAcount2").val(),
                phone: phone,
                fax: fax,
                tpType: $("#tpType2").val(),
                companyCode: $("#company2").val(),
                pOrg: $("#pOrg2").val(),
                currency: $("#currency2").val()
            },
            success: function(data) {
                if (data.status === 1) {
                    alert(data.message);
                    window.location.href = `/mm/vendor/display/${data.vendor_id}/?from_create=true`;
                } else {
                    alert(data.message);
                }
            },
            error: function(xhr, status, error) {
                try {
                    let response = JSON.parse(xhr.responseText);
                    alert("AJAX error: " + response.message);
                } catch (e) {
                    alert("AJAX error: " + xhr.responseText);
                }
            }
        });
    });

    function validatePhoneNumber(phone) {
        if (!phone) {
                return null; // Allow empty phone
            }
            if (phone.length !== 11) {
                return "Enter a valid 11-digit phone number.";
            }
            if (phone[0] !== '1') {
                return "Enter a valid phone number beginning with '1'.";
            }
            for (let i = 0; i < phone.length; i++) {
                if (!phone[i].match(/[0-9]/)) {
                    return "There is a character in the phone number.";
                }
            }
        return null;
    }

    function validateDigits(string) {
        for (let i = 0; i < string.length; i++) {
            if (!string[i].match(/[0-9]/)) {
                return "There is a non-digit character in fax.";
            }
        }
        return null;
    }

        $(function() {
            $('select.styled').customSelect();
        });

    </script>

{% endblock %}